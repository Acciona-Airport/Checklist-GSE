<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ingreso de Equipos - Acciona</title>
  <style>
    /* [Mantengo los mismos estilos anteriores] */
    .backup-notice {
      background-color: #333;
      border: 2px solid #c62828;
      padding: 15px;
      margin-top: 20px;
      border-radius: 8px;
      display: none;
    }
    .backup-btn {
      background-color: #2E7D32;
      margin-top: 10px;
    }
    .backup-btn:hover {
      background-color: #1B5E20;
    }
  </style>
</head>
<body>
  <!-- [Mantengo la misma estructura HTML anterior] -->
  
  <!-- Añado esta sección al final del container -->
  <div class="backup-notice" id="backup-notice">
    <h3>⚠️ Modo de Respaldo Activado</h3>
    <p>No se pudo conectar con el servidor principal. Los datos se guardarán localmente y se enviarán cuando se recupere la conexión.</p>
    <button class="btn backup-btn" id="backup-btn">Guardar Localmente</button>
    <div id="backup-status"></div>
  </div>

  <script>
    // URLs con múltiples endpoints de respaldo
    const URLS = {
      primary: "https://script.google.com/macros/s/AKfycbwQnLpbIFgi34GvjQPHUxgTX1bF18v-HlQdoaBTmk7KDw1ncqyU6X1WDGJw9oSQ6J7H/exec",
      backup1: "https://backup1.example.com/endpoint", // Reemplaza con tu backup real
      backup2: "https://backup2.example.com/endpoint"  // Reemplaza con tu backup real
    };

    // Sistema de reintentos
    const MAX_RETRIES = 3;
    let retryCount = 0;
    let offlineData = JSON.parse(localStorage.getItem('pendingSubmissions')) || [];

    // [Mantengo las funciones actualizarFechaHora, buscarDatosConductor, buscarDatosEquipo]
    
    // Función mejorada para enviar datos con múltiples fallbacks
    async function enviarFormulario() {
      const btn = document.getElementById("submit-btn");
      btn.disabled = true;
      btn.innerHTML = '<span class="loading"></span> Enviando...';

      const formData = recopilarDatosFormulario();
      
      if (!validarDatos(formData)) {
        btn.disabled = false;
        btn.innerText = 'Enviar';
        return;
      }

      try {
        // Intento con el servidor primario primero
        await enviarDatosConReintentos(URLS.primary, formData);
        
        // Si tiene éxito, procesar cualquier dato pendiente
        if (offlineData.length > 0) {
          await procesarDatosPendientes();
        }
        
        alert('✅ Datos enviados correctamente');
        location.reload();
      } catch (error) {
        console.error('Error principal:', error);
        
        // Mostrar opción de respaldo
        document.getElementById('backup-notice').style.display = 'block';
        document.getElementById('backup-btn').onclick = () => guardarLocalmente(formData);
        
        alert('⚠️ No se pudo conectar al servidor. Use la opción de respaldo.');
      } finally {
        btn.disabled = false;
        btn.innerText = 'Enviar';
      }
    }

    function recopilarDatosFormulario() {
      const rut = document.getElementById("rut-conductor").value.trim();
      const nombreManual = document.getElementById("nombre-manual").value.trim();
      const datosConductor = document.getElementById("datos-conductor").innerText.trim();
      const equipo = document.getElementById("numero-equipo").value.trim();
      const guardia = document.getElementById("guardia").value.trim();
      const familia = document.getElementById("familia-equipo").innerText.trim();
      const status = document.getElementById("status-equipo").innerText.trim();
      const obs = document.getElementById("observaciones-equipo").innerText.trim();

      return {
        rut: rut,
        nombre: datosConductor.includes("No encontrado") || datosConductor.includes("Error") ? nombreManual : datosConductor,
        equipo: equipo,
        familia: familia,
        habilitado: status,
        observaciones: obs,
        guardia: guardia,
        timestamp: new Date().toISOString()
      };
    }

    function validarDatos(data) {
      if (!data.rut || !/^[0-9]{7,8}-[0-9kK]{1}$/.test(data.rut)) {
        alert("⚠️ Ingrese un RUT válido (Formato: 12345678-9)");
        return false;
      }
      if (!data.equipo) {
        alert("⚠️ Ingrese el número de equipo");
        return false;
      }
      if (!data.nombre) {
        alert("⚠️ Ingrese el nombre del conductor");
        return false;
      }
      if (!data.guardia) {
        alert("⚠️ Ingrese el nombre del guardia");
        return false;
      }
      return true;
    }

    async function enviarDatosConReintentos(url, data, retries = MAX_RETRIES) {
      for (let i = 0; i < retries; i++) {
        try {
          const response = await fetch(url, {
            method: "POST",
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
          });

          if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
          
          const result = await response.json();
          if (result.success) return result;
          
          throw new Error(result.message || 'Error en la respuesta del servidor');
        } catch (error) {
          if (i === retries - 1) throw error;
          await new Promise(resolve => setTimeout(resolve, 1000 * (i + 1))); // Espera exponencial
        }
      }
    }

    function guardarLocalmente(data) {
      offlineData.push(data);
      localStorage.setItem('pendingSubmissions', JSON.stringify(offlineData));
      
      document.getElementById('backup-status').innerHTML = `
        <p>✅ Datos guardados localmente (${offlineData.length} pendientes)</p>
        <small>Se enviarán automáticamente cuando se recupere la conexión.</small>
      `;
      
      // Ocultar después de 5 segundos
      setTimeout(() => {
        document.getElementById('backup-notice').style.display = 'none';
      }, 5000);
    }

    async function procesarDatosPendientes() {
      const success = [];
      
      for (const data of offlineData) {
        try {
          await enviarDatosConReintentos(URLS.primary, data);
          success.push(data);
        } catch (error) {
          console.error('Error enviando dato pendiente:', error);
        }
      }
      
      // Eliminar solo los enviados con éxito
      offlineData = offlineData.filter(item => !success.includes(item));
      localStorage.setItem('pendingSubmissions', JSON.stringify(offlineData));
      
      if (success.length > 0) {
        console.log(`Enviados ${success.length} datos pendientes`);
      }
    }

    // Intenta enviar datos pendientes al cargar la página
    window.addEventListener('load', () => {
      if (offlineData.length > 0 && navigator.onLine) {
        procesarDatosPendientes();
      }
    });

    // Monitorear conexión
    window.addEventListener('online', () => {
      if (offlineData.length > 0) {
        procesarDatosPendientes();
      }
    });
  </script>
</body>
</html>
