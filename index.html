<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Ingreso de Equipos - Acciona</title>
  <style>
    /* ... mismo CSS que ya tienes ... */
  </style>
</head>
<body>
  <div class="container">
    <div class="logo-wrapper">
      <img class="logo" src="https://raw.githubusercontent.com/acciona-airport/Zarpes-acciona-aero/main/LogoAcciona2.png" alt="Logo Acciona" />
    </div>

    <h1>Formulario de Ingreso de Equipos (Base Acciona)</h1>

    <div class="datetime-box" id="datetime"></div>

    <form id="formulario-google" action="https://docs.google.com/forms/d/e/1FAIpQLSfLqrlBRhncuy7f4HIEdml9pTbvUhq0r9IsHeAcFYoZKO34zA/formResponse" method="POST" target="hidden_iframe" onsubmit="enviarFormulario(event)">

      <div class="section">
        <label for="rut-conductor">RUT del conductor <small>(Formato: 123456789-1)</small></label>
        <input type="text" id="rut-conductor" name="entry.675531615" placeholder="Ingrese RUT sin puntos y con guion." onblur="buscarDatosConductor()" required />
      </div>

      <div class="section">
        <label>Datos del Conductor:</label>
        <div class="result-box" id="datos-conductor"></div>
      </div>

      <div class="section" id="manual-conductor-section" style="display:none;">
        <label for="nombre-manual">Ingrese manualmente nombre del conductor:</label>
        <input type="text" id="nombre-manual" placeholder="Nombre completo del conductor" />
      </div>

      <input type="hidden" id="campo-nombre" name="entry.851525222" />

      <div class="section">
        <label for="numero-equipo">Número de Equipo:</label>
        <input type="text" id="numero-equipo" name="entry.1413809422" placeholder="Ej: 51125" onblur="buscarDatosEquipo()" required />
      </div>

      <input type="hidden" id="campo-familia" name="entry.783685052" />
      <input type="hidden" id="campo-habilitado" name="entry.10343893" />
      <input type="hidden" id="campo-observaciones" name="entry.2133373249" />

      <div class="section">
        <label>Familia del Equipo:</label>
        <div class="result-box" id="familia-equipo"></div>
      </div>

      <div class="section">
        <label>¿Habilitado para Ingreso?</label>
        <div class="result-box" id="status-equipo"></div>
        <div class="alert-box" id="alerta-ingreso">⚠️ Equipo no habilitado para ingreso. Contacte a Control Flota.</div>
      </div>

      <div class="section">
        <label>Observaciones:</label>
        <div class="result-box" id="observaciones-equipo"></div>
      </div>

      <div class="section">
        <label for="guardia">Guardia quien fiscaliza:</label>
        <input type="text" id="guardia" name="entry.234162856" placeholder="Nombre del guardia" required />
      </div>

      <button class="btn" type="submit">Enviar</button>
      <iframe name="hidden_iframe" style="display:none;"></iframe>
    </form>
  </div>

  <script>
    const URL_GET = "https://script.google.com/macros/s/AKfycbx5RL_GDtFwsKcMWyBYLwi2sdXtnkh9eXzdVs73jTS6zt3oAu9dmQwSeiyx43Tkt_QfeQ/exec";

    function actualizarFechaHora() {
      const now = new Date();
      document.getElementById("datetime").innerText = now.toLocaleString("es-CL");
    }
    actualizarFechaHora();

    async function buscarDatosConductor() {
      const rut = document.getElementById("rut-conductor").value.trim();
      const contenedor = document.getElementById("datos-conductor");
      const manualSection = document.getElementById("manual-conductor-section");

      if (!rut) {
        contenedor.innerText = "";
        manualSection.style.display = "none";
        return;
      }

      contenedor.innerText = "Buscando...";
      try {
        const response = await fetch(URL_GET + "?tipo=personal&id=" + encodeURIComponent(rut));
        const data = await response.json();
        if (data.error) {
          contenedor.innerText = "❌ No encontrado.";
          manualSection.style.display = "block";
        } else {
          contenedor.innerText = data.NOMBRE || "(sin nombre)";
          manualSection.style.display = "none";
        }
      } catch (e) {
        contenedor.innerText = "❌ Error al consultar.";
        manualSection.style.display = "block";
        console.error(e);
      }
    }

    async function buscarDatosEquipo() {
      const id = document.getElementById("numero-equipo").value.trim();
      const contenedorFamilia = document.getElementById("familia-equipo");
      const contenedorStatus = document.getElementById("status-equipo");
      const contenedorObs = document.getElementById("observaciones-equipo");
      const alerta = document.getElementById("alerta-ingreso");

      if (!id) {
        contenedorFamilia.innerText = "";
        contenedorStatus.innerText = "";
        contenedorObs.innerText = "";
        alerta.style.display = "none";
        return;
      }

      contenedorFamilia.innerText = contenedorStatus.innerText = contenedorObs.innerText = "Buscando...";
      alerta.style.display = "none";

      try {
        const response = await fetch(URL_GET + "?tipo=equipo&id=" + encodeURIComponent(id));
        const data = await response.json();

        if (data.error) {
          contenedorFamilia.innerText = contenedorStatus.innerText = contenedorObs.innerText = "❌ No encontrado";
        } else {
          contenedorFamilia.innerText = data.FAMILIA || "(sin dato)";
          contenedorObs.innerText = data.OBSERVACIONES || "(sin observaciones)";
          const status = (data["STATUS ✎"] || "").trim().toLowerCase();

          if (status === "operativo") {
            contenedorStatus.innerText = "❌ No habilitado para ingreso.";
            alerta.style.display = "block";
          } else {
            contenedorStatus.innerText = "✅ Sí habilitado para ingreso.";
            alerta.style.display = "none";
          }
        }
      } catch (e) {
        contenedorFamilia.innerText = contenedorStatus.innerText = contenedorObs.innerText = "❌ Error";
        alerta.style.display = "none";
        console.error(e);
      }
    }

    function enviarFormulario(event) {
      const datosConductor = document.getElementById("datos-conductor").innerText.trim();
      const nombreManual = document.getElementById("nombre-manual").value.trim();
      const nombre = datosConductor.includes("No encontrado") ? nombreManual : datosConductor;

      const familia = document.getElementById("familia-equipo").innerText.trim();
      const habilitado = document.getElementById("status-equipo").innerText.trim();
      const observaciones = document.getElementById("observaciones-equipo").innerText.trim();

      document.getElementById("campo-nombre").value = nombre;
      document.getElementById("campo-familia").value = familia;
      document.getElementById("campo-habilitado").value = habilitado;
      document.getElementById("campo-observaciones").value = observaciones;

      // Continúa el envío
      alert("✅ Enviado correctamente.");
    }
  </script>
</body>
</html>
